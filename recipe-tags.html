<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Tag Manager</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            margin-top: 0;
            color: #333;
        }
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #545b62;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        button.danger {
            background: #dc3545;
            padding: 4px 8px;
            font-size: 12px;
        }
        button.danger:hover {
            background: #c82333;
        }
        .tag-list, .recipe-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .tag-item, .recipe-item {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        .grid-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 600px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        th.recipe-header {
            text-align: left;
            min-width: 150px;
        }
        td.recipe-name {
            text-align: left;
            font-weight: 500;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .constraints-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .constraint-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .constraint-row select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .constraint-row input[type="number"] {
            width: 60px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .meal-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .meal-category {
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
        }
        .meal-category h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .empty-state {
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        .download-section {
            margin-top: 20px;
            padding: 20px;
            background: #d4edda;
            border-radius: 8px;
            text-align: center;
        }
        .info-text {
            color: #6c757d;
            font-size: 13px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Recipe Tag Manager</h1>
        <p>Create a database of recipes with tags, then download a meal planner that randomly selects meals for you.</p>

        <h3>Add Tags</h3>
        <div class="input-row">
            <input type="text" id="tagInput" placeholder="Enter tag name (e.g., breakfast, veggie forward, quick)">
            <button onclick="addTag()">Add Tag</button>
        </div>
        <div class="tag-list" id="tagList"></div>

        <h3 style="margin-top: 25px;">Add Recipes</h3>
        <div class="input-row">
            <input type="text" id="recipeInput" placeholder="Enter recipe name">
            <button onclick="addRecipe()">Add Recipe</button>
        </div>
    </div>

    <div class="container">
        <h2>Recipe Tag Grid</h2>
        <p class="info-text">Check which tags apply to each recipe. Meal categories (breakfast, lunch, dinner, snack) determine which meal slots recipes can fill.</p>
        <div class="grid-container" id="gridContainer">
            <div class="empty-state">Add some tags and recipes to see the grid</div>
        </div>
    </div>

    <div class="container">
        <h2>Meal Selection Constraints</h2>
        <p class="info-text">Set minimum requirements for each meal category. The downloaded planner will respect these constraints.</p>

        <div id="constraintsList">
            <div class="constraint-row">
                <span>Each meal category must have at least</span>
                <input type="number" id="minVeggieForward" value="1" min="0" max="3">
                <span>recipe(s) tagged as</span>
                <select id="constraintTag">
                    <option value="">-- select a tag --</option>
                </select>
            </div>
        </div>

        <div class="meal-categories">
            <div class="meal-category">
                <h4>Breakfast (3 meals)</h4>
                <p class="info-text">Recipes tagged "breakfast"</p>
            </div>
            <div class="meal-category">
                <h4>Lunch (3 meals)</h4>
                <p class="info-text">Recipes tagged "lunch"</p>
            </div>
            <div class="meal-category">
                <h4>Dinner (3 meals)</h4>
                <p class="info-text">Recipes tagged "dinner"</p>
            </div>
            <div class="meal-category">
                <h4>Snack (3 meals)</h4>
                <p class="info-text">Recipes tagged "snack"</p>
            </div>
        </div>
    </div>

    <div class="container download-section">
        <h2>Download Meal Planner</h2>
        <p>Download a standalone HTML file that will randomly select meals based on your recipes and constraints.</p>
        <button class="success" onclick="downloadMealPlanner()" style="font-size: 16px; padding: 12px 24px;">
            Download Meal Planner
        </button>
        <div id="downloadMessage" style="margin-top: 10px;"></div>
    </div>

    <!-- Meal Planner Template -->
    <template id="mealPlannerTemplate">
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Meal Planner</title>
            <style>
                body {
                    font-family: system-ui, -apple-system, sans-serif;
                    max-width: 900px;
                    margin: 20px auto;
                    padding: 20px;
                    background: #f5f5f5;
                }
                .container {
                    background: white;
                    padding: 30px;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                h1 {
                    margin-top: 0;
                    color: #333;
                    text-align: center;
                }
                .meal-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-top: 30px;
                }
                .meal-card {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 20px;
                    border-left: 4px solid #007bff;
                }
                .meal-card.breakfast { border-left-color: #ffc107; }
                .meal-card.lunch { border-left-color: #28a745; }
                .meal-card.dinner { border-left-color: #dc3545; }
                .meal-card.snack { border-left-color: #17a2b8; }
                .meal-card h3 {
                    margin: 0 0 15px 0;
                    color: #495057;
                    font-size: 14px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                }
                .meal-card ul {
                    margin: 0;
                    padding-left: 20px;
                }
                .meal-card li {
                    margin-bottom: 8px;
                    color: #333;
                }
                .meal-card li .tags {
                    font-size: 12px;
                    color: #6c757d;
                }
                .actions {
                    text-align: center;
                    margin-top: 30px;
                }
                button {
                    padding: 12px 24px;
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 16px;
                }
                button:hover {
                    background: #0056b3;
                }
                .constraint-info {
                    background: #e7f3ff;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                    font-size: 14px;
                    color: #004085;
                }
                .error {
                    background: #f8d7da;
                    color: #721c24;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>Your Meal Plan</h1>
                <div id="constraintInfo" class="constraint-info"></div>
                <div id="errorMessage" class="error" style="display: none;"></div>
                <div class="meal-grid" id="mealGrid"></div>
                <div class="actions">
                    <button onclick="generateMeals()">Generate New Meals</button>
                </div>
            </div>

            <script id="dataScript">
                const recipeData = __RECIPE_DATA_PLACEHOLDER__;
                const constraintData = __CONSTRAINT_DATA_PLACEHOLDER__;

                function shuffle(array) {
                    const arr = [...array];
                    for (let i = arr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [arr[i], arr[j]] = [arr[j], arr[i]];
                    }
                    return arr;
                }

                function getRecipesForCategory(category) {
                    return recipeData.recipes.filter(r => r.tags.includes(category));
                }

                function selectMeals(category, count, constraintTag, minWithTag) {
                    const available = getRecipesForCategory(category);
                    if (available.length === 0) {
                        return { meals: [], error: `No recipes tagged "${category}"` };
                    }

                    const withTag = available.filter(r => r.tags.includes(constraintTag));
                    const withoutTag = available.filter(r => !r.tags.includes(constraintTag));

                    let selected = [];

                    if (constraintTag && minWithTag > 0) {
                        if (withTag.length < minWithTag) {
                            return {
                                meals: [],
                                error: `Not enough "${category}" recipes with "${constraintTag}" tag (need ${minWithTag}, have ${withTag.length})`
                            };
                        }

                        // First, select required number with the constraint tag
                        const shuffledWithTag = shuffle(withTag);
                        selected = shuffledWithTag.slice(0, minWithTag);

                        // Fill remaining slots from all available (excluding already selected)
                        const remaining = available.filter(r => !selected.includes(r));
                        const shuffledRemaining = shuffle(remaining);
                        const needed = count - selected.length;
                        selected = selected.concat(shuffledRemaining.slice(0, needed));
                    } else {
                        const shuffled = shuffle(available);
                        selected = shuffled.slice(0, count);
                    }

                    return { meals: selected, error: null };
                }

                function generateMeals() {
                    const grid = document.getElementById('mealGrid');
                    const errorDiv = document.getElementById('errorMessage');
                    const constraintInfo = document.getElementById('constraintInfo');

                    errorDiv.style.display = 'none';
                    grid.innerHTML = '';

                    const constraintTag = constraintData.tag;
                    const minCount = constraintData.minCount;

                    if (constraintTag && minCount > 0) {
                        constraintInfo.textContent = `Constraint: At least ${minCount} recipe(s) per category must be tagged "${constraintTag}"`;
                    } else {
                        constraintInfo.textContent = 'No constraints applied - random selection from available recipes';
                    }

                    const categories = [
                        { name: 'breakfast', label: 'Breakfast', count: 3 },
                        { name: 'lunch', label: 'Lunch', count: 3 },
                        { name: 'dinner', label: 'Dinner', count: 3 },
                        { name: 'snack', label: 'Snack', count: 3 }
                    ];

                    let errors = [];

                    categories.forEach(cat => {
                        const result = selectMeals(cat.name, cat.count, constraintTag, minCount);

                        if (result.error) {
                            errors.push(result.error);
                        }

                        const card = document.createElement('div');
                        card.className = `meal-card ${cat.name}`;

                        let listHtml = '';
                        if (result.meals.length > 0) {
                            listHtml = '<ul>' + result.meals.map(m => {
                                const otherTags = m.tags.filter(t => t !== cat.name).join(', ');
                                return `<li>${m.name}${otherTags ? `<br><span class="tags">${otherTags}</span>` : ''}</li>`;
                            }).join('') + '</ul>';
                        } else {
                            listHtml = '<p style="color: #6c757d; font-style: italic;">No recipes available</p>';
                        }

                        card.innerHTML = `<h3>${cat.label}</h3>${listHtml}`;
                        grid.appendChild(card);
                    });

                    if (errors.length > 0) {
                        errorDiv.innerHTML = '<strong>Warnings:</strong><br>' + errors.join('<br>');
                        errorDiv.style.display = 'block';
                    }
                }

                // Generate meals on load
                generateMeals();
            </script>
        </body>
        </html>
    </template>

    <script>
        let tags = [];
        let recipes = [];

        // Load from localStorage
        function loadData() {
            const saved = localStorage.getItem('recipeTagData');
            if (saved) {
                const data = JSON.parse(saved);
                tags = data.tags || [];
                recipes = data.recipes || [];
                renderAll();
            }
        }

        function saveData() {
            localStorage.setItem('recipeTagData', JSON.stringify({ tags, recipes }));
        }

        function addTag() {
            const input = document.getElementById('tagInput');
            const tagName = input.value.trim().toLowerCase();
            if (tagName && !tags.includes(tagName)) {
                tags.push(tagName);
                input.value = '';
                saveData();
                renderAll();
            }
        }

        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            recipes.forEach(r => {
                r.tags = r.tags.filter(t => t !== tag);
            });
            saveData();
            renderAll();
        }

        function addRecipe() {
            const input = document.getElementById('recipeInput');
            const recipeName = input.value.trim();
            if (recipeName && !recipes.find(r => r.name === recipeName)) {
                recipes.push({ name: recipeName, tags: [] });
                input.value = '';
                saveData();
                renderAll();
            }
        }

        function removeRecipe(recipeName) {
            recipes = recipes.filter(r => r.name !== recipeName);
            saveData();
            renderAll();
        }

        function toggleTag(recipeName, tag) {
            const recipe = recipes.find(r => r.name === recipeName);
            if (recipe) {
                if (recipe.tags.includes(tag)) {
                    recipe.tags = recipe.tags.filter(t => t !== tag);
                } else {
                    recipe.tags.push(tag);
                }
                saveData();
            }
        }

        function renderTagList() {
            const container = document.getElementById('tagList');
            container.innerHTML = tags.map(tag => `
                <span class="tag-item">
                    ${tag}
                    <button class="danger" onclick="removeTag('${tag}')">Ã—</button>
                </span>
            `).join('');

            // Update constraint dropdown
            const select = document.getElementById('constraintTag');
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- select a tag --</option>' +
                tags.map(tag => `<option value="${tag}">${tag}</option>`).join('');
            select.value = currentValue;
        }

        function renderGrid() {
            const container = document.getElementById('gridContainer');

            if (tags.length === 0 || recipes.length === 0) {
                container.innerHTML = '<div class="empty-state">Add some tags and recipes to see the grid</div>';
                return;
            }

            let html = '<table><thead><tr><th class="recipe-header">Recipe</th>';
            tags.forEach(tag => {
                html += `<th>${tag}</th>`;
            });
            html += '<th></th></tr></thead><tbody>';

            recipes.forEach(recipe => {
                html += `<tr><td class="recipe-name">${recipe.name}</td>`;
                tags.forEach(tag => {
                    const checked = recipe.tags.includes(tag) ? 'checked' : '';
                    html += `<td><input type="checkbox" ${checked} onchange="toggleTag('${recipe.name.replace(/'/g, "\\'")}', '${tag}')"></td>`;
                });
                html += `<td><button class="danger" onclick="removeRecipe('${recipe.name.replace(/'/g, "\\'")}')">Remove</button></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderAll() {
            renderTagList();
            renderGrid();
        }

        function downloadMealPlanner() {
            const messageDiv = document.getElementById('downloadMessage');

            // Validate we have enough data
            const mealCategories = ['breakfast', 'lunch', 'dinner', 'snack'];
            const missingCategories = mealCategories.filter(cat => !tags.includes(cat));

            if (missingCategories.length > 0) {
                messageDiv.innerHTML = `<span style="color: #856404;">Note: Missing meal category tags: ${missingCategories.join(', ')}. Add these tags to recipes for full meal planning.</span>`;
            }

            if (recipes.length === 0) {
                messageDiv.innerHTML = '<span style="color: #dc3545;">Please add some recipes first.</span>';
                return;
            }

            // Get constraint settings
            const constraintTag = document.getElementById('constraintTag').value;
            const minCount = parseInt(document.getElementById('minVeggieForward').value) || 0;

            // Prepare data
            const recipeData = {
                recipes: recipes.map(r => ({ name: r.name, tags: [...r.tags] })),
                tags: [...tags]
            };

            const constraintData = {
                tag: constraintTag,
                minCount: minCount
            };

            // Generate the HTML
            const template = document.getElementById('mealPlannerTemplate');
            const parser = new DOMParser();
            const doc = parser.parseFromString(template.innerHTML, 'text/html');
            let html = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;

            // Replace placeholders
            html = html.replace('__RECIPE_DATA_PLACEHOLDER__', JSON.stringify(recipeData));
            html = html.replace('__CONSTRAINT_DATA_PLACEHOLDER__', JSON.stringify(constraintData));

            // Download
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meal-planner.html';
            a.click();
            URL.revokeObjectURL(url);

            messageDiv.innerHTML = '<span style="color: #28a745;">Meal planner downloaded!</span>';
        }

        // Handle Enter key
        document.getElementById('tagInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') addTag();
        });
        document.getElementById('recipeInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') addRecipe();
        });

        // Load saved data on startup
        loadData();
    </script>
</body>
</html>
