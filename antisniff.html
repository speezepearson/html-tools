<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-Sniff Password Entry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .description {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .password-container {
            position: relative;
            margin-bottom: 20px;
        }

        .password-display {
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            min-height: 50px;
            word-break: break-all;
            color: #333;
        }

        .password-display.empty {
            color: #999;
        }

        .password-display.masked {
            letter-spacing: 2px;
        }

        .toggle-visibility {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-visibility:hover {
            background: #5568d3;
        }

        .keyboard {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .keyboard-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .keyboard-row:nth-child(2) {
            padding-left: 40px;
        }

        .keyboard-row:nth-child(3) {
            padding-left: 60px;
        }

        .keyboard-row:nth-child(4) {
            padding-left: 100px;
        }

        .key {
            background: linear-gradient(180deg, #ffffff 0%, #f0f0f0 100%);
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px 12px;
            min-width: 80px;
            height: 65px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-around;
            gap: 10px;
            cursor: default;
            user-select: none;
            transition: all 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .key-background {
            font-size: 36px;
            color: #d8d8d8;
            font-weight: 700;
            pointer-events: none;
            flex-shrink: 0;
        }

        .key-glyphs {
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
            gap: 2px;
        }

        .key-shift {
            font-family: 'JetBrains Mono', 'SF Mono', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            color: #666;
            font-weight: 600;
            background: rgba(200, 200, 200, 0.25);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .key-normal {
            font-family: 'JetBrains Mono', 'SF Mono', 'Menlo', 'Consolas', monospace;
            font-size: 18px;
            color: #333;
            font-weight: 700;
            background: rgba(200, 200, 200, 0.25);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .key.space {
            min-width: 300px;
        }

        .key.special {
            background: linear-gradient(180deg, #e8e8e8 0%, #d8d8d8 100%);
            font-size: 12px;
            color: #555;
        }

        .key.enter {
            background: linear-gradient(180deg, #667eea 0%, #5568d3 100%);
            color: white;
            min-width: 100px;
        }

        .key.enter:hover {
            background: linear-gradient(180deg, #7688eb 0%, #6578e0 100%);
        }

        .key.backspace {
            min-width: 100px;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status.show {
            opacity: 1;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Anti-Sniff Password Entry</h1>
        <p class="description">
            Type on your physical keyboard. Each key shows what character it produces (large faint background)
            and what keys you should press to get that character (small foreground). The mapping randomizes
            after every keystroke to prevent acoustic keyboard sniffing. Press Enter to copy to clipboard.
        </p>

        <div class="password-container">
            <div id="passwordDisplay" class="password-display empty masked">Start typing on your keyboard...</div>
            <button id="toggleVisibility" class="toggle-visibility" style="display: none;">Show</button>
        </div>

        <div class="keyboard" id="keyboard"></div>

        <div id="status" class="status"></div>
    </div>

    <script>
        const STANDARD_LAYOUT = [
            ['`', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-', '='],
            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', '[', ']', '\\'],
            ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';', "'"],
            ['z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/'],
            [' ']
        ];

        const SHIFT_MAP = {
            '`': '~', '1': '!', '2': '@', '3': '#', '4': '$', '5': '%',
            '6': '^', '7': '&', '8': '*', '9': '(', '0': ')', '-': '_',
            '=': '+', '[': '{', ']': '}', '\\': '|', ';': ':', "'": '"',
            ',': '<', '.': '>', '/': '?', ' ': ' '
        };

        const CODE_TO_KEY = {
            'Backquote': '`', 'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4',
            'Digit5': '5', 'Digit6': '6', 'Digit7': '7', 'Digit8': '8', 'Digit9': '9',
            'Digit0': '0', 'Minus': '-', 'Equal': '=',
            'KeyQ': 'q', 'KeyW': 'w', 'KeyE': 'e', 'KeyR': 'r', 'KeyT': 't',
            'KeyY': 'y', 'KeyU': 'u', 'KeyI': 'i', 'KeyO': 'o', 'KeyP': 'p',
            'BracketLeft': '[', 'BracketRight': ']', 'Backslash': '\\',
            'KeyA': 'a', 'KeyS': 's', 'KeyD': 'd', 'KeyF': 'f', 'KeyG': 'g',
            'KeyH': 'h', 'KeyJ': 'j', 'KeyK': 'k', 'KeyL': 'l',
            'Semicolon': ';', 'Quote': "'",
            'KeyZ': 'z', 'KeyX': 'x', 'KeyC': 'c', 'KeyV': 'v', 'KeyB': 'b',
            'KeyN': 'n', 'KeyM': 'm', 'Comma': ',', 'Period': '.', 'Slash': '/',
            'Space': ' '
        };

        let password = '';
        let currentMapping = new Map();
        let reverseMapping = new Map();
        let showPassword = false;

        function cryptoRandom() {
            const array = new Uint32Array(1);
            crypto.getRandomValues(array);
            return array[0] / (0xFFFFFFFF + 1);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(cryptoRandom() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getAllStandardKeys() {
            const keys = [];
            STANDARD_LAYOUT.forEach(row => {
                row.forEach(key => keys.push(key));
            });
            return keys;
        }

        function getAllStandardCharacters() {
            const chars = [];
            STANDARD_LAYOUT.forEach(row => {
                row.forEach(key => {
                    chars.push(key);
                    const shiftChar = SHIFT_MAP[key] || key.toUpperCase();
                    chars.push(shiftChar);
                });
            });
            return chars;
        }

        function createMappings() {
            const allKeys = getAllStandardKeys();
            const allChars = getAllStandardCharacters();
            const shuffledChars = shuffleArray(allChars);

            const mapping = new Map();
            const reverse = new Map();

            let charIndex = 0;
            allKeys.forEach(key => {
                const normalChar = shuffledChars[charIndex++];
                const shiftChar = shuffledChars[charIndex++];

                mapping.set(key, { normal: normalChar, shift: shiftChar });

                if (!reverse.has(normalChar)) {
                    reverse.set(normalChar, { key: key, shift: false });
                }
                if (!reverse.has(shiftChar)) {
                    reverse.set(shiftChar, { key: key, shift: true });
                }
            });

            return { mapping, reverse };
        }

        function renderKeyboard() {
            const mappings = createMappings();
            currentMapping = mappings.mapping;
            reverseMapping = mappings.reverse;

            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';

            STANDARD_LAYOUT.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';

                row.forEach(standardKey => {
                    const standardShift = SHIFT_MAP[standardKey] || standardKey.toUpperCase();

                    const toTypeNormal = reverseMapping.get(standardKey);
                    const toTypeShift = reverseMapping.get(standardShift);

                    const keyDiv = document.createElement('div');
                    keyDiv.className = standardKey === ' ' ? 'key space' : 'key';

                    const bgSpan = document.createElement('div');
                    bgSpan.className = 'key-background';
                    bgSpan.textContent = standardKey === ' ' ? '⎵' : standardKey;
                    keyDiv.appendChild(bgSpan);

                    const glyphsDiv = document.createElement('div');
                    glyphsDiv.className = 'key-glyphs';

                    const shiftSpan = document.createElement('div');
                    shiftSpan.className = 'key-shift';
                    if (toTypeShift) {
                        if (toTypeShift.key === ' ') {
                            shiftSpan.textContent = '⎵';
                        } else if (toTypeShift.shift) {
                            const shiftedKey = SHIFT_MAP[toTypeShift.key] || toTypeShift.key.toUpperCase();
                            shiftSpan.textContent = shiftedKey;
                        } else {
                            shiftSpan.textContent = toTypeShift.key;
                        }
                    } else {
                        shiftSpan.textContent = '?';
                    }

                    const normalSpan = document.createElement('div');
                    normalSpan.className = 'key-normal';
                    if (toTypeNormal) {
                        if (toTypeNormal.key === ' ') {
                            normalSpan.textContent = '⎵';
                        } else if (toTypeNormal.shift) {
                            const shiftedKey = SHIFT_MAP[toTypeNormal.key] || toTypeNormal.key.toUpperCase();
                            normalSpan.textContent = shiftedKey;
                        } else {
                            normalSpan.textContent = toTypeNormal.key;
                        }
                    } else {
                        normalSpan.textContent = '?';
                    }

                    glyphsDiv.appendChild(shiftSpan);
                    glyphsDiv.appendChild(normalSpan);
                    keyDiv.appendChild(glyphsDiv);

                    rowDiv.appendChild(keyDiv);
                });

                keyboard.appendChild(rowDiv);
            });

            const lastRow = document.createElement('div');
            lastRow.className = 'keyboard-row';

            const backspaceKey = document.createElement('div');
            backspaceKey.className = 'key special backspace';
            backspaceKey.textContent = 'Backspace';

            const enterKey = document.createElement('div');
            enterKey.className = 'key special enter';
            enterKey.textContent = 'Enter to Copy';

            lastRow.appendChild(backspaceKey);
            lastRow.appendChild(enterKey);
            keyboard.appendChild(lastRow);
        }

        function handlePhysicalKeyPress(event) {
            // Ignore keyboard events with Cmd or Ctrl held
            if (event.metaKey || event.ctrlKey) {
                return;
            }

            if (event.key === 'Backspace') {
                event.preventDefault();
                if (password.length > 0) {
                    password = password.slice(0, -1);
                    updateDisplay();
                }
                return;
            }

            if (event.key === 'Enter') {
                event.preventDefault();
                handleEnter();
                return;
            }

            const physicalKey = CODE_TO_KEY[event.code];
            if (physicalKey) {
                const mapping = currentMapping.get(physicalKey);
                if (mapping) {
                    event.preventDefault();
                    const char = event.shiftKey ? mapping.shift : mapping.normal;
                    password += char;
                    updateDisplay();
                    renderKeyboard();
                }
            }
        }

        function handleEnter() {
            if (password.length === 0) {
                showStatus('Nothing to copy!', 'error');
                return;
            }

            navigator.clipboard.writeText(password).then(() => {
                showStatus('Password copied to clipboard!', 'success');
                password = '';
                showPassword = false;
                updateDisplay();
                renderKeyboard();
            }).catch(err => {
                showStatus('Failed to copy to clipboard', 'error');
                console.error('Clipboard error:', err);
            });
        }

        function updateDisplay() {
            const display = document.getElementById('passwordDisplay');
            const toggleBtn = document.getElementById('toggleVisibility');

            if (password.length === 0) {
                display.textContent = 'Start typing on your keyboard...';
                display.classList.add('empty');
                display.classList.add('masked');
                toggleBtn.style.display = 'none';
            } else {
                if (showPassword) {
                    display.textContent = password;
                    display.classList.remove('masked');
                } else {
                    display.textContent = '•'.repeat(password.length);
                    display.classList.add('masked');
                }
                display.classList.remove('empty');
                toggleBtn.style.display = 'block';
            }
        }

        function togglePasswordVisibility() {
            showPassword = !showPassword;
            const toggleBtn = document.getElementById('toggleVisibility');
            toggleBtn.textContent = showPassword ? 'Hide' : 'Show';
            updateDisplay();
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type} show`;
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        document.addEventListener('keydown', handlePhysicalKeyPress);
        document.getElementById('toggleVisibility').addEventListener('click', togglePasswordVisibility);
        renderKeyboard();
    </script>
</body>
</html>
